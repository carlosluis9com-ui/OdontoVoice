<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Odontograma</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for odontogram image capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Beta Lock Screen -->
    <div id="lock-screen"
        style="display: flex; height: 100vh; width: 100vw; align-items: center; justify-content: center; background: var(--background); position: fixed; top: 0; left: 0; z-index: 10000;">
        <div class="card"
            style="text-align: center; padding: 2rem; max-width: 90%; width: 400px; box-shadow: var(--shadow-lg);">
            <i class="fa-solid fa-lock" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h2>Acceso Restringido</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.95rem;">Validando invitación beta...
            </p>
            <div id="lock-spinner" style="font-size: 1.5rem; color: var(--primary);"><i
                    class="fa-solid fa-spinner fa-spin"></i></div>
            <div id="lock-error" class="hidden" style="color: var(--danger); margin-top: 1rem; font-weight: 500;">
                <i class="fa-solid fa-triangle-exclamation"></i> Enlace inválido o ya utilizado.
            </div>
        </div>
    </div>

    <div class="app-container hidden" id="main-app-container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <i class="fa-solid fa-tooth logo-icon"></i>
                <h1>OdontoVoice</h1>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div id="user-info" class="hidden" style="display: flex; align-items: center; gap: 8px;">
                    <img id="user-avatar" src="" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%;">
                    <button id="btn-history" class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;"><i
                            class="fa-solid fa-clock-rotate-left"></i> Historial</button>
                    <button id="btn-logout" class="btn btn-secondary"
                        style="padding: 4px 8px; font-size: 0.8rem;">Salir</button>
                </div>
                <button id="btn-login" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.9rem;"><i
                        class="fa-brands fa-google"></i> Ingresar</button>
                <button id="theme-toggle" class="icon-btn"><i class="fa-solid fa-moon"></i></button>
            </div>
        </header>

        <main id="main-content">
            <!-- Patient Data Section -->
            <section class="card patient-data-section">
                <h2><i class="fa-solid fa-user"></i> Datos del Paciente</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="p-name">Nombre Completo</label>
                        <input type="text" id="p-name" placeholder="Ej. Juan Pérez">
                    </div>
                    <div class="input-group row-2">
                        <div class="half-width">
                            <label for="p-age">Edad</label>
                            <input type="number" id="p-age" placeholder="Años">
                        </div>
                        <div class="half-width">
                            <label for="p-sex">Sexo</label>
                            <select id="p-sex">
                                <option value="">Seleccione...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="p-phone">Teléfono</label>
                        <input type="tel" id="p-phone" placeholder="Ej. 123456789">
                    </div>
                    <div class="input-group full-width">
                        <label for="p-pathologies">Patologías Registradas</label>
                        <textarea id="p-pathologies" rows="2" placeholder="Ej. Hipertensión, Diabetes..."></textarea>
                    </div>
                </div>
            </section>

            <!-- Odontogram Section -->
            <section class="card odontogram-section">
                <div class="section-header">
                    <h2><i class="fa-solid fa-teeth"></i> Odontodiagrama</h2>
                    <span class="status-badge">Adulto/Niño</span>
                </div>

                <div class="odontogram-container" id="odontogram-container">
                    <!-- Odontogram grid will be generated via JS to keep HTML clean -->
                    <div id="odontogram-adult-upper" class="jaw-row"></div>
                    <div id="odontogram-child-upper" class="jaw-row child-jaw"></div>
                    <div class="midline-divider"></div>
                    <div id="odontogram-child-lower" class="jaw-row child-jaw"></div>
                    <div id="odontogram-adult-lower" class="jaw-row"></div>
                </div>
            </section>

            <!-- Findings Section -->
            <section class="card findings-section">
                <h2><i class="fa-solid fa-list-check"></i> Hallazgos Clínicos</h2>

                <!-- Manual Entry Form -->
                <div class="manual-entry-form"
                    style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: flex-end; background: var(--background); padding: 1rem; border-radius: var(--radius-md); border: 1px solid var(--border);">
                    <div class="input-group" style="flex: 1; min-width: 70px;">
                        <label for="manual-unit">Pieza</label>
                        <input type="number" id="manual-unit" placeholder="Ej. 11">
                    </div>
                    <div class="input-group" style="flex: 2; min-width: 140px;">
                        <label for="manual-condition">Condición</label>
                        <select id="manual-condition">
                            <option value="">Seleccione...</option>
                            <option value="caries">Caries</option>
                            <option value="caries incipiente">Caries Incipiente</option>
                            <option value="caries moderada">Caries Moderada</option>
                            <option value="caries avanzada">Caries Avanzada</option>
                            <option value="fractura">Fractura</option>
                            <option value="restauracion">Restauración en Correctas Condiciones</option>
                            <option value="restauracion defectuosa">Restauración Defectuosa / Caries Recidiva</option>
                            <option value="sellante">Sellante</option>
                            <option value="exodoncia">Exodoncia</option>
                            <option value="ausencia">Diente Ausente</option>
                            <option value="endodoncia">Endodoncia</option>
                            <option value="diastema">Diastema</option>
                            <option value="giroversion derecha">Giroversión Derecha</option>
                            <option value="giroversion izquierda">Giroversión Izquierda</option>
                            <option value="abrasion">Abrasión / Erosión</option>
                            <option value="atriccion">Atricción</option>
                            <option value="erupcion">Diente en Erupción</option>
                        </select>
                    </div>
                    <div class="input-group" style="flex: 2; min-width: 130px;">
                        <label for="manual-face">Cara</label>
                        <select id="manual-face">
                            <option value="">Toda la pieza</option>
                            <option value="vestibular">Vestibular</option>
                            <option value="palatino">Palatino / Lingual</option>
                            <option value="mesial">Mesial</option>
                            <option value="distal">Distal</option>
                            <option value="oclusal">Oclusal / Incisal</option>
                            <optgroup label="Ubicación compuesta">
                                <option value="vestibular-mesial">Vestibular / Mesial</option>
                                <option value="vestibular-distal">Vestibular / Distal</option>
                                <option value="palatino-mesial">Palatino / Mesial</option>
                                <option value="palatino-distal">Palatino / Distal</option>
                                <option value="lingual-mesial">Lingual / Mesial</option>
                                <option value="lingual-distal">Lingual / Distal</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="btn-add-manual" class="btn btn-primary" style="height: 48px; padding: 0 1.25rem;"><i
                            class="fa-solid fa-plus"></i> Añadir</button>
                </div>

                <ul class="findings-list" id="findings-list">
                    <li class="empty-state">No hay hallazgos registrados. Use el micrófono o el formulario para
                        registrar.</li>
                    <!-- Findings will be populated here -->
                </ul>
            </section>
        </main>

        <!-- Generate Report View (Hidden by default) -->
        <main id="report-content" class="hidden">
            <section class="card report-section" id="pdf-export-area">
                <div class="report-header">
                    <i class="fa-solid fa-tooth report-logo"></i>
                    <h2>Informe Odontológico</h2>
                    <p class="report-date" id="report-date"></p>
                </div>

                <div class="report-body" contenteditable="true" id="editable-report">
                    <!-- Content populated by JS -->
                </div>

                <!-- We'll append a clone of the odontogram here for the PDF -->
                <div id="report-odontogram-mount"></div>
            </section>

            <div class="action-buttons-container">
                <button id="btn-back-to-edit" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i>
                    Volver</button>
                <button id="btn-download-pdf" class="btn btn-primary"><i class="fa-solid fa-file-pdf"></i> Guardar
                    PDF</button>
            </div>
        </main>

        <!-- Floating Mic Button -->
        <div class="mic-container" style="position: relative;">
            <div class="mic-ripple" id="mic-ripple"></div>
            <!-- Tooltip Beta -->
            <div class="beta-tooltip" id="beta-tooltip">
                <i class="fa-solid fa-circle-info"></i> Función experimental. Mejor experiencia en PC.
            </div>
            <button id="mic-btn" class="mic-btn">
                <i class="fa-solid fa-microphone"></i>
            </button>
            <div class="listening-status" id="listening-status">Tocá para hablar...</div>
        </div>

        <!-- Generate Report Button -->
        <button id="btn-generate-report" class="floating-action-btn">
            <i class="fa-solid fa-file-lines"></i>
            <span>Ver Informe</span>
        </button>

        <!-- Feedback Button -->
        <button id="btn-open-feedback" class="btn btn-secondary"
            style="position: fixed; bottom: 20px; left: 20px; z-index: 99; border-radius: 20px; box-shadow: var(--shadow-md);">
            <i class="fa-solid fa-comment-dots"></i> Feedback
        </button>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="hidden"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div class="card" style="width: 90%; max-width: 400px; padding: 20px; position: relative;">
                <button id="btn-close-feedback"
                    style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                <h3 style="margin-bottom: 15px;"><i class="fa-solid fa-lightbulb"></i> Enviar Sugerencia</h3>
                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px;">Ayúdanos a mejorar. ¿Qué
                    falla o qué te gustaría ver?</p>
                <textarea id="feedback-text" rows="4"
                    style="width: 100%; padding: 10px; border-radius: var(--radius-md); border: 1px solid var(--border); margin-bottom: 15px; background: var(--surface);"
                    placeholder="Escribe aquí tu opinión..."></textarea>
                <button id="btn-send-feedback" class="btn btn-primary" style="width: 100%;"><i
                        class="fa-solid fa-paper-plane"></i> Enviar</button>
            </div>
        </div>

        <!-- Beta Warning Modal -->
        <div id="beta-modal" class="hidden"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div class="card" style="width: 90%; max-width: 400px; padding: 20px; position: relative;">
                <h3 style="margin-bottom: 15px; color: var(--warning);"><i class="fa-solid fa-microphone-lines"></i>
                    Dictado por voz (Fase Beta)</h3>
                <p style="font-size: 0.95rem; color: var(--text-main); margin-bottom: 20px; line-height: 1.5;">
                    Estamos entrenando a nuestro asistente virtual. Para garantizar la mejor precisión y evitar cortes
                    en el audio, te recomendamos usar esta función desde el navegador de tu computadora (PC/Mac).
                </p>
                <button id="btn-close-beta-modal" class="btn btn-primary" style="width: 100%;">
                    ¡Entendido!
                </button>
            </div>
        </div>

        <!-- Patient History View (Hidden by default) -->
        <main id="history-content" class="hidden">
            <section class="card">
                <div class="section-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;"><i class="fa-solid fa-clock-rotate-left"></i> Historial</h2>
                    <button id="btn-back-from-history" class="btn btn-secondary" style="padding: 6px 12px;"><i
                            class="fa-solid fa-arrow-left"></i> Volver</button>
                </div>

                <input type="text" id="history-search-input" placeholder="Buscar por nombre..."
                    style="width: 100%; padding: 10px; border-radius: var(--radius-md); border: 1px solid var(--border); font-size: 16px; background: var(--surface); color: var(--text-main); margin-bottom: 1rem;">

                <div id="history-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <p style="text-align: center; color: var(--text-muted); padding: 2rem;"><i
                            class="fa-solid fa-spinner fa-spin"></i> Cargando...</p>
                </div>
            </section>
        </main>

        <!-- Patient Detail View (Hidden by default) -->
        <main id="history-detail" class="hidden">
            <section class="card">
                <div class="section-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;"><i class="fa-solid fa-user"></i> <span
                            id="detail-patient-name">Paciente</span></h2>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-detail-pdf" class="btn btn-primary" style="padding: 6px 12px;"><i
                                class="fa-solid fa-file-pdf"></i> PDF</button>
                        <button id="btn-back-from-detail" class="btn btn-secondary" style="padding: 6px 12px;"><i
                                class="fa-solid fa-arrow-left"></i> Volver</button>
                    </div>
                </div>
                <div id="detail-content"></div>
            </section>
        </main>

        <!-- Live Transcript Toast -->
        <div id="transcript-toast" class="toast"></div>
    </div>

    <script type="module" src="app.js"></script>
</body>

</html>